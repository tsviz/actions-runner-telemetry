name: Test Telemetry Action

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:
    inputs:
      telemetry_enabled:
        description: 'Enable telemetry collection'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  test-basic:
    name: Test Basic Usage
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Start telemetry
      - name: Start Telemetry
        uses: ./
        with:
          enabled: ${{ github.event.inputs.telemetry_enabled || 'true' }}

      # Simulate some work
      - name: Install Dependencies
        run: |
          echo "Simulating dependency installation..."
          python3 -c "
          import os, random
          for i in range(50):
              with open(f'/tmp/dep_{i}.txt', 'w') as f:
                  f.write('x' * random.randint(1000, 10000))
          "
          sleep 3

      - name: Build Application
        run: |
          echo "Simulating CPU-intensive build..."
          python3 -c "
          import math, hashlib
          result = 0
          for i in range(500000):
              result += math.sin(i) * math.cos(i)
              hashlib.sha256(str(i).encode()).hexdigest()
          print(f'Build completed with result: {result}')
          "

      - name: Run Tests
        run: |
          echo "Simulating memory-intensive tests..."
          python3 -c "
          import random
          data = [random.random() for _ in range(12500000)]
          result = sum(data) / len(data)
          print(f'Tests passed with average: {result}')
          "

      # Stop and generate report
      - name: Stop Telemetry
        if: always()
        uses: ./
        with:
          mode: stop
          enabled: ${{ github.event.inputs.telemetry_enabled || 'true' }}

      - name: Upload Telemetry Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: telemetry-basic-${{ github.run_id }}
          path: |
            telemetry-report.html
            telemetry-raw.json
            telemetry-samples.csv
            telemetry-steps.csv
            telemetry-summary.json
          retention-days: 14
          if-no-files-found: warn

  test-with-steps:
    name: Test With Step Markers
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Start telemetry
      - name: Start Telemetry
        uses: ./
        with:
          enabled: ${{ github.event.inputs.telemetry_enabled || 'true' }}

      # Mark steps for per-step tracking
      - name: Mark - Install
        uses: ./
        with:
          mode: step
          step-name: "Install Dependencies"
          enabled: ${{ github.event.inputs.telemetry_enabled || 'true' }}

      - name: Install Dependencies
        run: |
          echo "Simulating dependency installation..."
          sleep 3

      - name: Mark - Build
        uses: ./
        with:
          mode: step
          step-name: "Build Application"
          enabled: ${{ github.event.inputs.telemetry_enabled || 'true' }}

      - name: Build Application
        run: |
          echo "Simulating build..."
          python3 -c "
          import math
          result = sum(math.sin(i) for i in range(1000000))
          print(f'Build done: {result}')
          "

      - name: Mark - Test
        uses: ./
        with:
          mode: step
          step-name: "Run Tests"
          enabled: ${{ github.event.inputs.telemetry_enabled || 'true' }}

      - name: Run Tests
        run: |
          echo "Simulating tests..."
          sleep 2

      # Stop and generate report
      - name: Stop Telemetry
        if: always()
        uses: ./
        with:
          mode: stop
          enabled: ${{ github.event.inputs.telemetry_enabled || 'true' }}

      - name: Upload Telemetry Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: telemetry-steps-${{ github.run_id }}
          path: |
            telemetry-report.html
            telemetry-raw.json
          retention-days: 14
          if-no-files-found: warn

  test-disabled:
    name: Test Disabled Mode
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Start telemetry with enabled=false
      - name: Start Telemetry (Disabled)
        id: telemetry
        uses: ./
        with:
          enabled: false

      - name: Verify Disabled
        run: |
          echo "Telemetry enabled output: ${{ steps.telemetry.outputs.enabled }}"
          if [ "${{ steps.telemetry.outputs.enabled }}" = "false" ]; then
            echo "âœ… Telemetry correctly disabled"
          else
            echo "âš ï¸ Telemetry should be disabled"
          fi

      - name: Some Work
        run: |
          echo "Running some work without telemetry..."
          sleep 2

      - name: Stop Telemetry (Disabled)
        if: always()
        uses: ./
        with:
          mode: stop
          enabled: false

      - name: Verify No Report Generated
        run: |
          if [ -f "telemetry-report.html" ]; then
            echo "âš ï¸ Report should not exist when disabled"
            exit 1
          else
            echo "âœ… No report generated (as expected)"
          fi

  test-snapshot:
    name: Test Snapshot Mode
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Take Snapshot
        uses: ./
        with:
          mode: snapshot

      - name: Verify Snapshot Output
        run: |
          echo "Checking for telemetry output..."
          if [ -f "telemetry-report.html" ]; then
            echo "âœ… Snapshot report generated"
            ls -la telemetry-*
          else
            echo "âš ï¸ No snapshot report found"
          fi

  test-scenarios:
    name: Test Comprehensive Scenarios
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Start telemetry
      - name: Start Telemetry
        uses: ./
        with:
          enabled: true

      # Scenario 1: Heavy Memory Load
      - name: Scenario 1 - Heavy Memory Load
        run: |
          echo "ðŸ“Š Scenario 1: Allocating 1.5GB memory..."
          python3 -c "
          import sys
          # Allocate 1.5GB of memory
          arrays = [list(range(125000000)) for _ in range(3)]
          print('âœ… Allocated 1.5GB successfully')
          print(f'Memory in use: {sys.getsizeof(arrays) // (1024*1024)}MB')
          "

      # Scenario 2: Heavy CPU Load
      - name: Scenario 2 - Heavy CPU Load
        run: |
          echo "ðŸ“Š Scenario 2: Running CPU-intensive work..."
          python3 -c "
          import math, time
          start = time.time()
          result = 0
          for i in range(100000000):
              result += math.sin(i) * math.cos(i)
          elapsed = time.time() - start
          print(f'âœ… Completed 100M iterations in {elapsed:.2f}s')
          print(f'Result: {result}')
          "

      # Scenario 3: Balanced Load
      - name: Scenario 3 - Balanced Load (CPU + Memory)
        run: |
          echo "ðŸ“Š Scenario 3: Running balanced workload..."
          python3 -c "
          import math, time
          # Allocate some memory
          data = [0] * (1024 * 1024 * 1024)  # 1GB
          print('âœ… Allocated 1GB memory')
          # Do some CPU work
          result = sum(math.sin(i) for i in range(10000000))
          print(f'âœ… Completed CPU work: {result}')
          "

      # Scenario 4: Multiple Sequential Steps (marked with step tracker)
      - name: "Scenario 4.1 - Compile"
        uses: ./
        with:
          mode: step
          step-name: "Compile"
          enabled: true

      - name: Scenario 4.1 - Compile Work
        run: echo "Compiling..." && sleep 1

      - name: "Scenario 4.2 - Test"
        uses: ./
        with:
          mode: step
          step-name: "Test"
          enabled: true

      - name: Scenario 4.2 - Test Work
        run: echo "Testing..." && sleep 1

      - name: "Scenario 4.3 - Build"
        uses: ./
        with:
          mode: step
          step-name: "Build"
          enabled: true

      - name: Scenario 4.3 - Build Work
        run: echo "Building..." && sleep 1

      - name: "Scenario 4.4 - Deploy"
        uses: ./
        with:
          mode: step
          step-name: "Deploy"
          enabled: true

      - name: Scenario 4.4 - Deploy Work
        run: echo "Deploying..." && sleep 1

      # Scenario 5: Light Workload (Baseline)
      - name: Scenario 5 - Light Workload
        run: |
          echo "ðŸ“Š Scenario 5: Light workload baseline..."
          sleep 2
          echo "âœ… Light workload complete"

      # Stop telemetry and generate report
      - name: Stop Telemetry
        if: always()
        uses: ./
        with:
          mode: stop
          enabled: true

      # Validate metrics were captured
      - name: Validate Metrics
        if: always()
        run: |
          echo "ðŸ“Š Validating telemetry results..."
          if [ -f "telemetry-report.html" ]; then
            echo "âœ… Telemetry report generated"
            # Check file size - should have content
            size=$(stat -f%z "telemetry-report.html" 2>/dev/null || stat -c%s "telemetry-report.html" 2>/dev/null || echo "0")
            if [ "$size" -gt 1000 ]; then
              echo "âœ… Report contains data (size: $size bytes)"
            fi
          else
            echo "âš ï¸ Warning: telemetry-report.html not found"
          fi
          
          if [ -f "telemetry-raw.json" ]; then
            echo "âœ… Raw telemetry data captured"
            python3 -c "
            import json
            with open('telemetry-raw.json') as f:
              data = json.load(f)
            samples = len(data.get('samples', []))
            steps = len(data.get('steps', []))
            print(f'  â€¢ Samples collected: {samples}')
            print(f'  â€¢ Steps tracked: {steps}')
            if samples > 0:
              print('  âœ… Metrics captured successfully')
            "
          fi

      - name: Upload Telemetry Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: telemetry-scenarios-${{ github.run_id }}
          path: |
            telemetry-report.html
            telemetry-raw.json
            telemetry-samples.csv
            telemetry-steps.csv
            telemetry-summary.json
          retention-days: 14
          if-no-files-found: ignore
