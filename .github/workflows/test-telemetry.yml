name: Test Telemetry Action

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:
    inputs:
      telemetry_enabled:
        description: 'Enable telemetry collection'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  test-basic:
    name: Test Basic Usage
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Start telemetry
      - name: Start Telemetry
        uses: ./
        with:
          enabled: ${{ github.event.inputs.telemetry_enabled || 'true' }}

      # Simulate some work
      - name: Install Dependencies
        run: |
          echo "Simulating dependency installation..."
          python3 -c "
          import os, random
          for i in range(50):
              with open(f'/tmp/dep_{i}.txt', 'w') as f:
                  f.write('x' * random.randint(1000, 10000))
          "
          sleep 3

      - name: Build Application
        run: |
          echo "Simulating CPU-intensive build..."
          python3 -c "
          import math, hashlib
          result = 0
          for i in range(500000):
              result += math.sin(i) * math.cos(i)
              hashlib.sha256(str(i).encode()).hexdigest()
          print(f'Build completed with result: {result}')
          "

      - name: Run Tests
        run: |
          echo "Simulating memory-intensive tests..."
          python3 -c "
          import random
          data = [random.random() for _ in range(12500000)]
          result = sum(data) / len(data)
          print(f'Tests passed with average: {result}')
          "

      # Stop and generate report
      - name: Stop Telemetry
        if: always()
        uses: ./
        with:
          mode: stop
          enabled: ${{ github.event.inputs.telemetry_enabled || 'true' }}

      - name: Upload Telemetry Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: telemetry-basic-${{ github.run_id }}
          path: |
            telemetry-report.html
            telemetry-raw.json
            telemetry-samples.csv
            telemetry-steps.csv
            telemetry-summary.json
          retention-days: 14
          if-no-files-found: warn

  test-with-steps:
    name: Test With Step Markers
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Start telemetry
      - name: Start Telemetry
        uses: ./
        with:
          enabled: ${{ github.event.inputs.telemetry_enabled || 'true' }}

      # Mark steps for per-step tracking
      - name: Mark - Install
        uses: ./
        with:
          mode: step
          step-name: "Install Dependencies"
          enabled: ${{ github.event.inputs.telemetry_enabled || 'true' }}

      - name: Install Dependencies
        run: |
          echo "Simulating dependency installation..."
          sleep 3

      - name: Mark - Build
        uses: ./
        with:
          mode: step
          step-name: "Build Application"
          enabled: ${{ github.event.inputs.telemetry_enabled || 'true' }}

      - name: Build Application
        run: |
          echo "Simulating build..."
          python3 -c "
          import math
          result = sum(math.sin(i) for i in range(1000000))
          print(f'Build done: {result}')
          "

      - name: Mark - Test
        uses: ./
        with:
          mode: step
          step-name: "Run Tests"
          enabled: ${{ github.event.inputs.telemetry_enabled || 'true' }}

      - name: Run Tests
        run: |
          echo "Simulating tests..."
          sleep 2

      # Stop and generate report
      - name: Stop Telemetry
        if: always()
        uses: ./
        with:
          mode: stop
          enabled: ${{ github.event.inputs.telemetry_enabled || 'true' }}

      - name: Upload Telemetry Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: telemetry-steps-${{ github.run_id }}
          path: |
            telemetry-report.html
            telemetry-raw.json
          retention-days: 14
          if-no-files-found: warn

  test-disabled:
    name: Test Disabled Mode
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Start telemetry with enabled=false
      - name: Start Telemetry (Disabled)
        id: telemetry
        uses: ./
        with:
          enabled: false

      - name: Verify Disabled
        run: |
          echo "Telemetry enabled output: ${{ steps.telemetry.outputs.enabled }}"
          if [ "${{ steps.telemetry.outputs.enabled }}" = "false" ]; then
            echo "‚úÖ Telemetry correctly disabled"
          else
            echo "‚ö†Ô∏è Telemetry should be disabled"
          fi

      - name: Some Work
        run: |
          echo "Running some work without telemetry..."
          sleep 2

      - name: Stop Telemetry (Disabled)
        if: always()
        uses: ./
        with:
          mode: stop
          enabled: false

      - name: Verify No Report Generated
        run: |
          if [ -f "telemetry-report.html" ]; then
            echo "‚ö†Ô∏è Report should not exist when disabled"
            exit 1
          else
            echo "‚úÖ No report generated (as expected)"
          fi

  test-snapshot:
    name: Test Snapshot Mode
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Take Snapshot
        uses: ./
        with:
          mode: snapshot

      - name: Verify Snapshot Output
        run: |
          echo "Checking for telemetry output..."
          if [ -f "telemetry-report.html" ]; then
            echo "‚úÖ Snapshot report generated"
            ls -la telemetry-*
          else
            echo "‚ö†Ô∏è No snapshot report found"
          fi

  test-scenarios:
    name: Test Comprehensive Scenarios
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Start telemetry
      - name: Start Telemetry
        uses: ./
        with:
          enabled: true

      # Scenario 1: CPU-Heavy Work
      - name: Scenario 1 - Mark CPU Work Start
        uses: ./
        with:
          mode: step
          step-name: "CPU Heavy"
          enabled: true

      - name: Scenario 1 - Heavy CPU Load
        run: |
          echo "üìä Scenario 1: Running CPU-intensive work..."
          python3 -c "
          import math, time
          start = time.time()
          result = 0
          for i in range(100000000):
              result += math.sin(i) * math.cos(i)
          elapsed = time.time() - start
          print(f'‚úÖ Completed 100M iterations in {elapsed:.2f}s')
          print(f'Result: {result}')
          "

      # Scenario 2: Sequential Steps (Multi-Step)
      - name: "Scenario 2.1 - Compile"
        uses: ./
        with:
          mode: step
          step-name: "Compile"
          enabled: true

      - name: Scenario 2.1 - Compile Work
        run: echo "Compiling..." && sleep 1

      - name: "Scenario 2.2 - Test"
        uses: ./
        with:
          mode: step
          step-name: "Test"
          enabled: true

      - name: Scenario 2.2 - Test Work
        run: echo "Testing..." && sleep 1

      - name: "Scenario 2.3 - Build"
        uses: ./
        with:
          mode: step
          step-name: "Build"
          enabled: true

      - name: Scenario 2.3 - Build Work
        run: echo "Building..." && sleep 1

      - name: "Scenario 2.4 - Deploy"
        uses: ./
        with:
          mode: step
          step-name: "Deploy"
          enabled: true

      - name: Scenario 2.4 - Deploy Work
        run: echo "Deploying..." && sleep 1

      # Scenario 3: Light Workload (Baseline)
      - name: "Scenario 3 - Light Work"
        uses: ./
        with:
          mode: step
          step-name: "Light Work"
          enabled: true

      - name: Scenario 3 - Light Workload
        run: |
          echo "üìä Scenario 3: Light workload baseline..."
          sleep 2
          echo "‚úÖ Light workload complete"

      # Stop telemetry and generate report
      - name: Stop Telemetry
        if: always()
        uses: ./
        with:
          mode: stop
          enabled: true

      # Validate metrics were captured
      - name: Validate Metrics
        if: always()
        run: |
          echo "üìä Validating telemetry results..."
          if [ -f "telemetry-report.md" ]; then
            echo "‚úÖ Telemetry report generated"
          fi
          
          if [ -f "telemetry-raw.json" ]; then
            echo "‚úÖ Raw telemetry data captured"
            python3 << 'VALIDATE_EOF'
            import json
            with open('telemetry-raw.json') as f:
            data = json.load(f)
            samples = len(data.get('samples', []))
            steps = len(data.get('steps', []))
            print(f'  ‚Ä¢ Samples collected: {samples}')
            print(f'  ‚Ä¢ Steps tracked: {steps}')
            if samples > 0 and steps > 0:
            print('  ‚úÖ Metrics captured successfully')
            VALIDATE_EOF
                    fi

      - name: Upload Telemetry Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: telemetry-scenarios-${{ github.run_id }}
          path: |
            telemetry-report.md
            telemetry-raw.json
            telemetry-samples.csv
            telemetry-steps.csv
            telemetry-summary.json
          retention-days: 14
          if-no-files-found: ignore
