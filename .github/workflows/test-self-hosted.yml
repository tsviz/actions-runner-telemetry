name: Test Self-Hosted Runner

on:
  workflow_dispatch:
    inputs:
      runner:
        description: 'Self-hosted runner label'
        required: true
        default: 'self-hosted-macos'
        type: choice
        options:
          - self-hosted-macos
          - self-hosted-windows
          - self-hosted-linux

jobs:
  test-runner:
    runs-on: ${{ inputs.runner }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4.2.2

    - name: Runner Telemetry Action
      uses: tsviz/actions-runner-telemetry@v1

    # Environment Info
    - name: Test runner environment (Linux/macOS)
      if: runner.os != 'Windows'
      shell: bash
      run: |
        echo "Running on: $(hostname)"
        echo "OS: $(uname -s)"
        echo "Architecture: $(uname -m)"
        echo "Working directory: $(pwd)"
        echo "Node.js version: $(node --version)"
        echo "npm version: $(npm --version)"

    - name: Test runner environment (Windows)
      if: runner.os == 'Windows'
      shell: powershell
      run: |
        Write-Host "Running on: $env:COMPUTERNAME"
        Write-Host "OS: $env:OS"
        Write-Host "Architecture: $env:PROCESSOR_ARCHITECTURE"
        Write-Host "Working directory: $(Get-Location)"
        Write-Host "Node.js version: $(node --version)"
        Write-Host "npm version: $(npm --version)"

    # CPU Stress Test - Multi-core Load
    - name: CPU Stress Test - Multi-core Load (Linux/macOS)
      if: runner.os != 'Windows'
      shell: bash
      run: |
        echo "Starting CPU stress test on all cores..."
        CORES=$(getconf _NPROCESSORS_ONLN 2>/dev/null || sysctl -n hw.ncpu)
        echo "Detected $CORES CPU cores"
        for i in $(seq 1 "$CORES"); do
          yes > /dev/null &
        done
        sleep 120
        killall yes || pkill yes
        echo "CPU stress test completed"

    - name: CPU Stress Test - Multi-core Load (Windows)
      if: runner.os == 'Windows'
      shell: powershell
      run: |
        Write-Host "Starting CPU stress test on all cores..."
        $cores = [Environment]::ProcessorCount
        Write-Host "Detected $cores CPU cores"
        $scriptBlock = {
          $end = (Get-Date).AddSeconds(30)
          while ((Get-Date) -lt $end) {
            [Math]::Sqrt(12345) | Out-Null
          }
        }
        $jobs = @()
        for ($i=0; $i -lt $cores; $i++) {
          $jobs += Start-Job -ScriptBlock $scriptBlock
        }
        if ($jobs.Count -gt 0) {
          Wait-Job -Job $jobs
          Remove-Job -Job $jobs
        }
        Write-Host "CPU stress test completed"

    # Memory Stress Test
    - name: Memory Stress Test - RAM Consumption (Linux/macOS)
      if: runner.os != 'Windows'
      shell: bash
      run: |
        python3 << 'EOF'
        import time, sys
        print(f"Starting memory stress test on platform: {sys.platform}")
        print('Allocating 1GB of memory...')
        data = []
        for i in range(100):
            chunk = bytearray(10 * 1024 * 1024)
            data.append(chunk)
            if i % 10 == 0:
                print(f'Allocated {(i+1)*10}MB')
        print('Holding memory for 60 seconds...')
        time.sleep(60)
        print('Memory test completed')
        EOF

    - name: Memory Stress Test - RAM Consumption (Windows)
      if: runner.os == 'Windows'
      shell: powershell
      run: |
        Write-Host "Starting memory stress test..."
        Write-Host "Allocating 256MB of memory..."
        $data = @()
        for ($i = 0; $i -lt 16; $i++) {
          $chunk = New-Object byte[] (16 * 1024 * 1024)
          $data += ,$chunk
          Write-Host "Allocated $((($i + 1) * 16))MB"
        }
        Write-Host "Holding memory for 15 seconds..."
        Start-Sleep -Seconds 15
        Write-Host "Memory test completed"

    # Disk I/O Stress Test
    - name: Disk I/O Stress Test - Heavy Read/Write (Linux/macOS)
      if: runner.os != 'Windows'
      shell: bash
      run: |
        echo "Starting intensive disk I/O operations..."
        mkdir -p stress_io_test
        cd stress_io_test
        echo "Writing large files with dd..."
        for i in {1..10}; do
          dd if=/dev/zero of=testfile_${i}.bin bs=1M count=100 &
        done
        wait
        echo "Reading files back..."
        for round in {1..5}; do
          echo "Read round $round"
          for file in *.bin; do
            dd if="$file" of=/dev/null bs=1M &
          done
          wait
        done
        echo "Performing random I/O operations..."
        for i in {1..100}; do
          dd if=/dev/urandom of=random_${i}.bin bs=1K count=1024 2>/dev/null &
        done
        wait
        cd ..
        rm -rf stress_io_test
        echo "Disk I/O stress test completed"

    - name: Disk I/O Stress Test - Read/Write (Windows)
      if: runner.os == 'Windows'
      shell: powershell
      run: |
        Write-Host "Starting disk I/O operations..."
        $dir = "stress_io_test"
        if (!(Test-Path $dir)) { New-Item -ItemType Directory -Path $dir | Out-Null }
        Set-Location $dir
        Write-Host "Writing 3 x 10MB files..."
        for ($i = 1; $i -le 3; $i++) {
          $bytes = New-Object Byte[] (10 * 1024 * 1024)
          [System.IO.File]::WriteAllBytes("testfile_$i.bin", $bytes)
          Write-Host "Wrote testfile_$i.bin"
        }
        Write-Host "Reading files back..."
        for ($round = 1; $round -le 2; $round++) {
          Write-Host "Read round $round"
          Get-ChildItem -Filter *.bin | ForEach-Object {
            [System.IO.File]::ReadAllBytes($_.FullName) | Out-Null
          }
        }
        Write-Host "Writing 5 random 1MB files..."
        for ($i = 1; $i -le 5; $i++) {
          $r = New-Object Byte[] (1024 * 1024)
          (New-Object Random).NextBytes($r)
          [System.IO.File]::WriteAllBytes("random_$i.bin", $r)
        }
        Set-Location ..
        Remove-Item -Recurse -Force $dir
        Write-Host "Disk I/O test completed"

    # Network Stress Test
    - name: Network Stress Test - Heavy Downloads (Linux/macOS)
      if: runner.os != 'Windows'
      shell: bash
      run: |
        echo "Starting network stress test..."
        mkdir -p network_stress
        cd network_stress
        urls=(
          "https://github.com/git/git/archive/refs/tags/v2.43.0.tar.gz"
          "https://nodejs.org/dist/v20.10.0/node-v20.10.0.tar.gz"
          "https://archive.apache.org/dist/maven/maven-3/3.9.6/binaries/apache-maven-3.9.6-bin.tar.gz"
          "https://github.com/actions/runner/releases/download/v2.312.0/actions-runner-osx-x64-2.312.0.tar.gz"
        )
        echo "Downloading files in parallel..."
        for i in "${!urls[@]}"; do
          curl -L "${urls[$i]}" -o "download_${i}.tar.gz" &
        done
        wait
        echo "Re-downloading files to stress network..."
        for i in "${!urls[@]}"; do
          curl -L "${urls[$i]}" -o "download_${i}_2.tar.gz" &
        done
        wait
        cd ..
        rm -rf network_stress
        echo "Network stress test completed"

    - name: Network Test - Downloads (Windows)
      if: runner.os == 'Windows'
      shell: powershell
      run: |
        Write-Host "Starting network test..."
        $dir = "network_test"
        if (!(Test-Path $dir)) { New-Item -ItemType Directory -Path $dir | Out-Null }
        Set-Location $dir
        $urls = @(
          "https://raw.githubusercontent.com/actions/runner/main/README.md",
          "https://raw.githubusercontent.com/actions/checkout/main/README.md"
        )
        Write-Host "Downloading files..."
        for ($i = 0; $i -lt $urls.Count; $i++) {
          Invoke-WebRequest -Uri $urls[$i] -OutFile "download_$i.md"
          Write-Host "Downloaded file $i"
        }
        Set-Location ..
        Remove-Item -Recurse -Force $dir
        Write-Host "Network test completed"
