name: Test Self-Hosted Runner

on:
  workflow_dispatch:
    inputs:
      runner:
        description: 'Self-hosted runner label'
        required: true
        default: 'self-hosted-macos'
        type: choice
        options:
          - self-hosted-macos
          - self-hosted-windows
          - self-hosted-linux

jobs:
  test-runner:
    runs-on: ${{ inputs.runner }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4.2.2

    - name: Runner Telemetry Action
      uses: tsviz/actions-runner-telemetry@v1

    # Environment Info
    - name: Test runner environment (Linux/macOS)
      if: runner.os != 'Windows'
      shell: bash
      run: |
        echo "Running on: $(hostname)"
        echo "OS: $(uname -s)"
        echo "Architecture: $(uname -m)"
        echo "Working directory: $(pwd)"
        echo "Node.js version: $(node --version)"
        echo "npm version: $(npm --version)"

    - name: Test runner environment (Windows)
      if: runner.os == 'Windows'
      shell: powershell
      run: |
        Write-Host "Running on: $env:COMPUTERNAME"
        Write-Host "OS: $env:OS"
        Write-Host "Architecture: $env:PROCESSOR_ARCHITECTURE"
        Write-Host "Working directory: $(Get-Location)"
        Write-Host "Node.js version: $(node --version)"
        Write-Host "npm version: $(npm --version)"

    # CPU Stress Test - Multi-core Load
    - name: CPU Stress Test - Multi-core Load (Linux/macOS)
      if: runner.os != 'Windows'
      shell: bash
      run: |
        echo "Starting CPU stress test on all cores..."
        CORES=$(getconf _NPROCESSORS_ONLN 2>/dev/null || sysctl -n hw.ncpu)
        echo "Detected $CORES CPU cores"
        for i in $(seq 1 "$CORES"); do
          yes > /dev/null &
        done
        sleep 120
        killall yes || pkill yes
        echo "CPU stress test completed"

    - name: CPU Stress Test - Multi-core Load (Windows)
      if: runner.os == 'Windows'
      shell: powershell
      run: |
        Write-Host "Starting CPU stress test on all cores..."
        $cores = [Environment]::ProcessorCount
        Write-Host "Detected $cores CPU cores"
        $scriptBlock = {
          $end = (Get-Date).AddSeconds(120)
          while ((Get-Date) -lt $end) {
            [Math]::Sqrt(12345) | Out-Null
          }
        }
        $jobs = @()
        for ($i=0; $i -lt $cores; $i++) {
          $jobs += Start-Job -ScriptBlock $scriptBlock
        }
        if ($jobs.Count -gt 0) {
          Wait-Job -Job $jobs
          Remove-Job -Job $jobs
        }
        Write-Host "CPU stress test completed"

    # Memory Stress Test
    - name: Memory Stress Test - RAM Consumption (Linux/macOS/Windows)
      shell: python
      run: |
        import time, sys
        print(f"Starting memory stress test on platform: {sys.platform}")
        print('Allocating 1GB of memory...')
        data = []
        for i in range(100):
            chunk = bytearray(10 * 1024 * 1024)
            data.append(chunk)
            if i % 10 == 0:
                print(f'Allocated {(i+1)*10}MB')
        print('Holding memory for 60 seconds...')
        time.sleep(60)
        print('Memory test completed')

    # Disk I/O Stress Test
    - name: Disk I/O Stress Test - Heavy Read/Write (Linux/macOS)
      if: runner.os != 'Windows'
      shell: bash
      run: |
        echo "Starting intensive disk I/O operations..."
        mkdir -p stress_io_test
        cd stress_io_test
        echo "Writing large files with dd..."
        for i in {1..10}; do
          dd if=/dev/zero of=testfile_${i}.bin bs=1M count=100 &
        done
        wait
        echo "Reading files back..."
        for round in {1..5}; do
          echo "Read round $round"
          for file in *.bin; do
            dd if="$file" of=/dev/null bs=1M &
          done
          wait
        done
        echo "Performing random I/O operations..."
        for i in {1..100}; do
          dd if=/dev/urandom of=random_${i}.bin bs=1K count=1024 2>/dev/null &
        done
        wait
        cd ..
        rm -rf stress_io_test
        echo "Disk I/O stress test completed"

    - name: Disk I/O Stress Test - Heavy Read/Write (Windows)
      if: runner.os == 'Windows'
      shell: powershell
      run: |
        Write-Host "Starting intensive disk I/O operations..."
        $ErrorActionPreference = "Stop"
        $dir = "stress_io_test"
        if (!(Test-Path $dir)) { New-Item -ItemType Directory -Path $dir | Out-Null }
        Set-Location $dir
        $dirPath = (Get-Location).Path
        Write-Host "Writing large files..."
        $jobs = @()
        for ($i=1; $i -le 10; $i++) {
          $outFile = Join-Path $dirPath "testfile_$i.bin"
          $jobs += Start-Job -ScriptBlock {
            param($outFile)
            $f=[System.IO.File]::Create($outFile)
            $bytes = New-Object Byte[] (100*1024*1024)
            $f.Write($bytes, 0, $bytes.Length)
            $f.Close()
          } -ArgumentList $outFile
        }
        if ($jobs.Count -gt 0) { Wait-Job -Job $jobs; Remove-Job -Job $jobs }
        Write-Host "Reading files back sequentially..."
        for ($round=1; $round -le 5; $round++) {
          Write-Host "Read round $round"
          $files = Get-ChildItem -Path $dirPath -Filter *.bin
          if ($files.Count -eq 0) { throw "No .bin files found!" }
          foreach ($file in $files) {
            [System.IO.File]::ReadAllBytes($file.FullName) | Out-Null
          }
        }
        Write-Host "Performing random I/O operations..."
        $jobs = @()
        for ($i=1; $i -le 100; $i++) {
          $outFile = Join-Path $dirPath "random_$i.bin"
          $jobs += Start-Job -ScriptBlock {
            param($outFile)
            $r = New-Object Byte[] (1024*1024)
            (New-Object Random).NextBytes($r)
            [System.IO.File]::WriteAllBytes($outFile, $r)
          } -ArgumentList $outFile
        }
        if ($jobs.Count -gt 0) { Wait-Job -Job $jobs; Remove-Job -Job $jobs }
        Set-Location ..
        Remove-Item -Recurse -Force $dir
        Write-Host "Disk I/O stress test completed"

    # Network Stress Test
    - name: Network Stress Test - Heavy Downloads (Linux/macOS)
      if: runner.os != 'Windows'
      shell: bash
      run: |
        echo "Starting network stress test..."
        mkdir -p network_stress
        cd network_stress
        urls=(
          "https://github.com/git/git/archive/refs/tags/v2.43.0.tar.gz"
          "https://nodejs.org/dist/v20.10.0/node-v20.10.0.tar.gz"
          "https://archive.apache.org/dist/maven/maven-3/3.9.6/binaries/apache-maven-3.9.6-bin.tar.gz"
          "https://github.com/actions/runner/releases/download/v2.312.0/actions-runner-osx-x64-2.312.0.tar.gz"
        )
        echo "Downloading files in parallel..."
        for i in "${!urls[@]}"; do
          curl -L "${urls[$i]}" -o "download_${i}.tar.gz" &
        done
        wait
        echo "Re-downloading files to stress network..."
        for i in "${!urls[@]}"; do
          curl -L "${urls[$i]}" -o "download_${i}_2.tar.gz" &
        done
        wait
        cd ..
        rm -rf network_stress
        echo "Network stress test completed"

    - name: Network Stress Test - Heavy Downloads (Windows)
      if: runner.os == 'Windows'
      shell: powershell
      run: |
        Write-Host "Starting network stress test..."
        $dir = "network_stress"
        if (!(Test-Path $dir)) { New-Item -ItemType Directory -Path $dir | Out-Null }
        Set-Location $dir
        $urls = @(
          "https://github.com/git/git/archive/refs/tags/v2.43.0.tar.gz",
          "https://nodejs.org/dist/v20.10.0/node-v20.10.0.tar.gz",
          "https://archive.apache.org/dist/maven/maven-3/3.9.6/binaries/apache-maven-3.9.6-bin.tar.gz",
          "https://github.com/actions/runner/releases/download/v2.312.0/actions-runner-osx-x64-2.312.0.tar.gz"
        )
        Write-Host "Downloading files in parallel..."
        $jobs = @()
        for ($i=0; $i -lt $urls.Count; $i++) {
          $outFile = "download_$i.tar.gz"
          $jobs += Start-Job -ScriptBlock {
            param($url, $outFile)
            Invoke-WebRequest -Uri $url -OutFile $outFile
          } -ArgumentList $urls[$i], $outFile
        }
        if ($jobs.Count -gt 0) { Wait-Job -Job $jobs; Remove-Job -Job $jobs }
        Write-Host "Re-downloading files to stress network..."
        $jobs = @()
        for ($i=0; $i -lt $urls.Count; $i++) {
          $outFile = "download_${i}_2.tar.gz"
          $jobs += Start-Job -ScriptBlock {
            param($url, $outFile)
            Invoke-WebRequest -Uri $url -OutFile $outFile
          } -ArgumentList $urls[$i], $outFile
        }
        if ($jobs.Count -gt 0) { Wait-Job -Job $jobs; Remove-Job -Job $jobs }
        Set-Location ..
        Remove-Item -Recurse -Force $dir
        Write-Host "Network stress test completed"
