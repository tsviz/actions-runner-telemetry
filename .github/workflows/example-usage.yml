name: Example CI with Telemetry

# This workflow demonstrates the telemetry action using simulated workloads.
# Copy this pattern and replace the simulation steps with your actual build commands.

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:  # Allow manual triggers for testing

env:
  # Set to 'false' to disable telemetry without modifying the workflow
  TELEMETRY_ENABLED: 'true'

jobs:
  build:
    name: Build & Test (Demo)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
      # â•‘  START TELEMETRY                                               â•‘
      # â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: Start Telemetry
        uses: tsviz/actions-runner-telemetry@v1.1.0
        with:
          enabled: ${{ env.TELEMETRY_ENABLED }}

      # Simulated workload steps (replace with your actual build commands)
      - name: Simulate Install Dependencies
        run: |
          echo "ðŸ“¦ Simulating dependency installation..."
          # Create some CPU load
          for i in {1..3}; do
            echo "Installing package $i..."
            dd if=/dev/urandom bs=1M count=10 2>/dev/null | gzip > /dev/null
            sleep 1
          done
          echo "âœ… Dependencies installed"

      - name: Simulate Build
        run: |
          echo "ðŸ”¨ Simulating build process..."
          # Create CPU + memory load
          python3 -c "
          import time
          data = []
          for i in range(5):
              data.append('x' * (1024 * 1024 * 10))  # 10MB chunks
              print(f'Building module {i+1}/5...')
              time.sleep(1)
          print('âœ… Build complete')
          "

      - name: Simulate Tests
        run: |
          echo "ðŸ§ª Running tests..."
          # Parallel test simulation
          for i in {1..4}; do
            (dd if=/dev/urandom bs=512K count=5 2>/dev/null | gzip > /dev/null; echo "Test suite $i passed âœ“") &
          done
          wait
          echo "âœ… All tests passed"

      - name: Simulate Lint
        run: |
          echo "ðŸ” Linting code..."
          sleep 2
          echo "âœ… No linting issues found"

      # â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
      # â•‘  STOP TELEMETRY - Use if: always() to run even if steps fail  â•‘
      # â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: Stop Telemetry
        if: always()
        uses: tsviz/actions-runner-telemetry@v1.1.0
        with:
          mode: stop
          enabled: ${{ env.TELEMETRY_ENABLED }}

      # Upload telemetry artifacts (optional)
      - name: Upload Telemetry Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: telemetry-${{ github.run_id }}
          path: |
            telemetry-report.md
            telemetry-dashboard.html
            telemetry-raw.json
            telemetry-samples.csv
            telemetry-summary.json
          retention-days: 14
          if-no-files-found: ignore

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ALTERNATIVE: With per-step tracking for detailed analysis
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build-with-steps:
    name: Build & Test (With Step Tracking)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Start telemetry
      - name: Start Telemetry
        uses: tsviz/actions-runner-telemetry@v1.1.0
        with:
          enabled: ${{ env.TELEMETRY_ENABLED }}

      # â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
      # â•‘  OPTIONAL STEP MARKERS - Track per-step resources             â•‘
      # â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      - name: '[Telemetry] Install Dependencies'
        uses: tsviz/actions-runner-telemetry@v1.1.0
        with:
          mode: step
          step-name: "Install Dependencies"
          enabled: ${{ env.TELEMETRY_ENABLED }}

      - name: Install Dependencies
        run: |
          echo "ðŸ“¦ Installing dependencies..."
          for i in {1..3}; do
            dd if=/dev/urandom bs=1M count=5 2>/dev/null | gzip > /dev/null
            sleep 1
          done

      - name: '[Telemetry] Build'
        uses: tsviz/actions-runner-telemetry@v1.1.0
        with:
          mode: step
          step-name: "Build"
          enabled: ${{ env.TELEMETRY_ENABLED }}

      - name: Build
        run: |
          echo "ðŸ”¨ Building..."
          python3 -c "
          import time
          for i in range(3):
              data = 'x' * (1024 * 1024 * 20)
              print(f'Compiling module {i+1}...')
              time.sleep(1)
          "

      - name: '[Telemetry] Test'
        uses: tsviz/actions-runner-telemetry@v1.1.0
        with:
          mode: step
          step-name: "Test"
          enabled: ${{ env.TELEMETRY_ENABLED }}

      - name: Test
        run: |
          echo "ðŸ§ª Testing..."
          for i in {1..3}; do
            echo "Running test suite $i..."
            sleep 1
          done

      # Stop and generate report
      - name: Stop Telemetry
        if: always()
        uses: tsviz/actions-runner-telemetry@v1.1.0
        with:
          mode: stop
          enabled: ${{ env.TELEMETRY_ENABLED }}

      - name: Upload Telemetry Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: telemetry-detailed-${{ github.run_id }}
          path: |
            telemetry-report.md
            telemetry-dashboard.html
          retention-days: 14
          if-no-files-found: ignore

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # QUICK CHECK: Snapshot mode for one-time capture
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  quick-check:
    name: Quick Resource Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Some Work
        run: |
          echo "Running quick workload..."
          dd if=/dev/urandom bs=1M count=20 2>/dev/null | gzip > /dev/null
          sleep 2

      # Take a snapshot at this point in time
      - name: Resource Snapshot
        uses: tsviz/actions-runner-telemetry@v1.1.0
        with:
          mode: snapshot
          enabled: ${{ env.TELEMETRY_ENABLED }}

      - name: Upload Snapshot
        uses: actions/upload-artifact@v4
        with:
          name: resource-snapshot
          path: telemetry-report.md
          if-no-files-found: ignore

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # OVERUTILIZED: Heavy workload that needs a larger runner
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  heavy-workload:
    name: Heavy Build (Over Utilized)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Start telemetry
      - name: Start Telemetry
        uses: tsviz/actions-runner-telemetry@v1.1.0
        with:
          enabled: ${{ env.TELEMETRY_ENABLED }}

      # Heavy parallel workload that maxes out the runner
      - name: Heavy CPU & Memory Load
        run: |
          echo "âš ï¸  Running heavy workload that will max out available resources..."
          python3 -c "
          import concurrent.futures
          import time
          import math
          
          def heavy_computation(n):
              '''Simulate heavy computation'''
              result = 0
              for i in range(n):
                  result += math.sin(i) * math.cos(i) * math.sqrt(abs(i))
              return result
          
          # Allocate large memory blocks
          print('ðŸ“Š Allocating memory blocks...')
          data_blocks = []
          for i in range(5):
              data_blocks.append([0] * (1024 * 1024 * 50))  # 50MB blocks
              print(f'  Allocated block {i+1}/5 (50MB)')
          
          # Run parallel CPU-intensive tasks
          print('âš¡ Running parallel computations...')
          with concurrent.futures.ThreadPoolExecutor(max_workers=6) as executor:
              futures = [executor.submit(heavy_computation, 5000000) for _ in range(6)]
              results = [f.result() for f in concurrent.futures.as_completed(futures)]
              print(f'  Computed {len(results)} heavy tasks')
          
          # Additional disk I/O under load
          print('ðŸ’¾ Disk I/O under memory pressure...')
          import subprocess
          for i in range(3):
              subprocess.run('dd if=/dev/urandom bs=10M count=100 of=/tmp/load_test_{i}.bin 2>/dev/null', shell=True)
          
          print('âœ… Heavy workload complete')
          "

      # Mark major work sections
      - name: '[Telemetry] Data Processing'
        uses: tsviz/actions-runner-telemetry@v1.1.0
        with:
          mode: step
          step-name: "Data Processing"
          enabled: ${{ env.TELEMETRY_ENABLED }}

      - name: Data Processing
        run: |
          echo "Processing large datasets..."
          python3 -c "
          import random
          import time
          # Simulate data processing without external dependencies
          print('Creating and processing large datasets...')
          for i in range(3):
              # Create large list (simulating data array)
              data = [random.random() for _ in range(10000000)]
              result = sum(data) / len(data)
              print(f'  Processed dataset {i+1}/3 (avg: {result:.4f})')
          print('Data processing complete')
          "

      # Stop and generate report
      - name: Stop Telemetry
        if: always()
        uses: tsviz/actions-runner-telemetry@v1.1.0
        with:
          mode: stop
          enabled: ${{ env.TELEMETRY_ENABLED }}

      - name: Upload Heavy Workload Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: telemetry-heavy-${{ github.run_id }}
          path: |
            telemetry-report.md
            telemetry-dashboard.html
            telemetry-summary.json
          retention-days: 14
          if-no-files-found: ignore
