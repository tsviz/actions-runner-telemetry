name: Example CI with Telemetry

# This workflow demonstrates the telemetry action using simulated workloads.
# Copy this pattern and replace the simulation steps with your actual build commands.

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:  # Allow manual triggers for testing

env:
  # Set to 'false' to disable telemetry without modifying the workflow
  TELEMETRY_ENABLED: 'true'

jobs:
  build:
    name: Build & Test (Demo)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
      # â•‘  START TELEMETRY                                               â•‘
      # â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: Start Telemetry
        uses: tsviz/actions-runner-telemetry@v1.1.0
        with:
          enabled: ${{ env.TELEMETRY_ENABLED }}

      # Simulated workload steps (replace with your actual build commands)
      - name: Simulate Install Dependencies
        run: |
          echo "ğŸ“¦ Simulating dependency installation..."
          # Create some CPU load
          for i in {1..3}; do
            echo "Installing package $i..."
            dd if=/dev/urandom bs=1M count=10 2>/dev/null | gzip > /dev/null
            sleep 1
          done
          echo "âœ… Dependencies installed"

      - name: Simulate Build
        run: |
          echo "ğŸ”¨ Simulating build process..."
          # Create CPU + memory load
          python3 -c "
          import time
          data = []
          for i in range(5):
              data.append('x' * (1024 * 1024 * 10))  # 10MB chunks
              print(f'Building module {i+1}/5...')
              time.sleep(1)
          print('âœ… Build complete')
          "

      - name: Simulate Tests
        run: |
          echo "ğŸ§ª Running tests..."
          # Parallel test simulation
          for i in {1..4}; do
            (dd if=/dev/urandom bs=512K count=5 2>/dev/null | gzip > /dev/null; echo "Test suite $i passed âœ“") &
          done
          wait
          echo "âœ… All tests passed"

      - name: Simulate Lint
        run: |
          echo "ğŸ” Linting code..."
          sleep 2
          echo "âœ… No linting issues found"

      # â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
      # â•‘  STOP TELEMETRY - Use if: always() to run even if steps fail  â•‘
      # â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: Stop Telemetry
        if: always()
        uses: tsviz/actions-runner-telemetry@v1.1.0
        with:
          mode: stop
          enabled: ${{ env.TELEMETRY_ENABLED }}

      # Upload telemetry artifacts (optional)
      - name: Upload Telemetry Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: telemetry-${{ github.run_id }}
          path: |
            telemetry-report.md
            telemetry-dashboard.html
            telemetry-raw.json
            telemetry-samples.csv
            telemetry-summary.json
          retention-days: 14
          if-no-files-found: ignore

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ALTERNATIVE: With per-step tracking for detailed analysis
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build-with-steps:
    name: Build & Test (With Step Tracking)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Start telemetry
      - name: Start Telemetry
        uses: tsviz/actions-runner-telemetry@v1.1.0
        with:
          enabled: ${{ env.TELEMETRY_ENABLED }}

      # â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
      # â•‘  OPTIONAL STEP MARKERS - Track per-step resources             â•‘
      # â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      - name: '[Telemetry] Install Dependencies'
        uses: tsviz/actions-runner-telemetry@v1.1.0
        with:
          mode: step
          step-name: "Install Dependencies"
          enabled: ${{ env.TELEMETRY_ENABLED }}

      - name: Install Dependencies
        run: |
          echo "ğŸ“¦ Installing dependencies..."
          for i in {1..3}; do
            dd if=/dev/urandom bs=1M count=5 2>/dev/null | gzip > /dev/null
            sleep 1
          done

      - name: '[Telemetry] Build'
        uses: tsviz/actions-runner-telemetry@v1.1.0
        with:
          mode: step
          step-name: "Build"
          enabled: ${{ env.TELEMETRY_ENABLED }}

      - name: Build
        run: |
          echo "ğŸ”¨ Building..."
          python3 -c "
          import time
          for i in range(3):
              data = 'x' * (1024 * 1024 * 20)
              print(f'Compiling module {i+1}...')
              time.sleep(1)
          "

      - name: '[Telemetry] Test'
        uses: tsviz/actions-runner-telemetry@v1.1.0
        with:
          mode: step
          step-name: "Test"
          enabled: ${{ env.TELEMETRY_ENABLED }}

      - name: Test
        run: |
          echo "ğŸ§ª Testing..."
          for i in {1..3}; do
            echo "Running test suite $i..."
            sleep 1
          done

      # Stop and generate report
      - name: Stop Telemetry
        if: always()
        uses: tsviz/actions-runner-telemetry@v1.1.0
        with:
          mode: stop
          enabled: ${{ env.TELEMETRY_ENABLED }}

      - name: Upload Telemetry Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: telemetry-detailed-${{ github.run_id }}
          path: |
            telemetry-report.md
            telemetry-dashboard.html
          retention-days: 14
          if-no-files-found: ignore

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # QUICK CHECK: Snapshot mode for one-time capture
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  quick-check:
    name: Quick Resource Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Some Work
        run: |
          echo "Running quick workload..."
          dd if=/dev/urandom bs=1M count=20 2>/dev/null | gzip > /dev/null
          sleep 2

      # Take a snapshot at this point in time
      - name: Resource Snapshot
        uses: tsviz/actions-runner-telemetry@v1.1.0
        with:
          mode: snapshot
          enabled: ${{ env.TELEMETRY_ENABLED }}

      - name: Upload Snapshot
        uses: actions/upload-artifact@v4
        with:
          name: resource-snapshot
          path: telemetry-report.md
          if-no-files-found: ignore

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # OVERUTILIZED: Heavy workload that needs a larger runner
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  heavy-workload:
    name: Heavy Build (Over Utilized)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Start telemetry
      - name: Start Telemetry
        uses: tsviz/actions-runner-telemetry@v1.1.0
        with:
          enabled: ${{ env.TELEMETRY_ENABLED }}

      # Heavy parallel workload that maxes out the runner
      - name: Heavy CPU & Memory Load
        run: |
          echo "âš ï¸  Running heavy workload that will max out available resources..."
          python3 << 'PYTHON_EOF'
          import multiprocessing
          import time
          import os
          
          def intensive_compute(task_id):
              """CPU-intensive computation using multiprocessing (no GIL)"""
              result = 0
              # Heavy computation loop - calculate prime-like operations
              for i in range(50000000):
                  result += (i * i) % 1000000
                  if i % (i if i > 0 else 1) == 0 and i > 100000:
                      # Simulate additional work
                      _ = sum([j * j for j in range(1000)])
              return result
          
          print("ğŸ“Š Starting heavy parallel computation with multiple processes...")
          print(f"   CPU Count: {os.cpu_count()}")
          
          # Force allocation of memory BEFORE computation
          print("ğŸ’¾ Pre-allocating memory (600MB)...")
          large_data = []
          for i in range(6):
              # Allocate 100MB blocks
              block = bytearray(100 * 1024 * 1024)
              large_data.append(block)
              print(f"   Block {i+1}/6 allocated (100MB)")
          
          # Run CPU-intensive tasks in parallel using multiprocessing
          print("âš¡ Spawning parallel worker processes...")
          start_time = time.time()
          
          # Use all available CPU cores for computation
          with multiprocessing.Pool(processes=os.cpu_count()) as pool:
              tasks = [pool.apply_async(intensive_compute, (i,)) for i in range(os.cpu_count() * 2)]
              results = [task.get() for task in tasks]
          
          elapsed = time.time() - start_time
          print(f"âœ… Heavy computation complete ({elapsed:.1f}s)")
          print(f"   Processed {len(results)} parallel tasks")
          print(f"   Peak memory: ~600MB sustained")
          
          # Final disk I/O under heavy memory load
          print("ğŸ’¾ Disk I/O while under memory pressure...")
          import subprocess
          for i in range(2):
              subprocess.run(f'dd if=/dev/urandom bs=50M count=20 of=/tmp/heavy_load_{i}.bin 2>/dev/null', shell=True)
          
          print("âœ… All heavy workloads complete - runner should show high utilization")
          PYTHON_EOF
          

      # Mark major work sections
      - name: '[Telemetry] Data Processing'
        uses: tsviz/actions-runner-telemetry@v1.1.0
        with:
          mode: step
          step-name: "Data Processing"
          enabled: ${{ env.TELEMETRY_ENABLED }}

      - name: Data Processing
        run: |
          echo "Processing large datasets..."
          python3 -c "
          import random
          import time
          # Simulate data processing without external dependencies
          print('Creating and processing large datasets...')
          for i in range(3):
              # Create large list (simulating data array)
              data = [random.random() for _ in range(10000000)]
              result = sum(data) / len(data)
              print(f'  Processed dataset {i+1}/3 (avg: {result:.4f})')
          print('Data processing complete')
          "

      # Stop and generate report
      - name: Stop Telemetry
        if: always()
        uses: tsviz/actions-runner-telemetry@v1.1.0
        with:
          mode: stop
          enabled: ${{ env.TELEMETRY_ENABLED }}

      - name: Upload Heavy Workload Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: telemetry-heavy-${{ github.run_id }}
          path: |
            telemetry-report.md
            telemetry-dashboard.html
            telemetry-summary.json
          retention-days: 14
          if-no-files-found: ignore
