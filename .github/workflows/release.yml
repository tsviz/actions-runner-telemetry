name: Create Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  create-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract version from tag
        id: version
        run: |
          TAG=${{ github.ref_name }}
          VERSION=${TAG#v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Generate Release Notes
        id: notes
        run: |
          cat > release_notes.md << 'EOF'
          # Runner Telemetry Action v${{ steps.version.outputs.version }}

          Comprehensive GitHub Actions runner telemetry collection and analysis with cost optimization insights.

          ## ðŸŽ¯ Key Features

          ### ðŸ“Š Resource Monitoring
          - Real-time CPU, Memory, I/O, and Network metrics
          - Per-step performance tracking and analysis
          - Interactive HTML dashboards with Chart.js visualizations
          - Time-series data collection with configurable intervals

          ### ðŸ’° Cost Optimization Analysis
          - **Utilization Scoring** - Weighted score (CPU 60%, Memory 40%) from 0-100%
          - **Overutilization Detection** - Identifies jobs exceeding runner capacity (Grade D for 90%+ peaks)
          - **Right-Sizing Recommendations** - Suggests more cost-effective runners based on usage patterns
          - **Monthly Cost Projections** - Estimates per-run and projected monthly costs
          - **GitHub Pricing Integration** - Links to official GitHub Actions runner pricing documentation

          ### ðŸ” Detailed Analysis
          - Idle time detection (CPU <5% for extended periods)
          - I/O wait and CPU steal metrics
          - Disk and network throughput tracking
          - Process-level statistics (top processes by CPU/memory)
          - Step-level resource breakdown

          ### ðŸ“ˆ Reporting & Dashboards
          - **Markdown Reports** - Step Summary integration with Mermaid diagrams
          - **Interactive HTML Dashboard** - Shareable, self-contained visualization
          - **CSV Export** - Raw telemetry data export
          - **JSON Data** - Machine-readable format for custom analysis
          - **Summary JSON** - High-level metrics overview

          ## ðŸš€ Usage

          ```yaml
          - name: Start Telemetry
            uses: tsviz/actions-runner-telemetry@v1

          # Your build steps here...

          - name: Stop & Generate Report
            uses: tsviz/actions-runner-telemetry@v1
            with:
              mode: stop
            if: always()
          ```

          ## ðŸ“‹ Modes

          - **start** - Begin collecting metrics in background
          - **stop** - Stop collection and generate report (markdown + HTML + JSON)
          - **step** - Mark step boundaries for per-step analysis
          - **snapshot** - Quick single-point capture

          ## ðŸ’¡ Example Workflows

          See [`.github/workflows/example-usage.yml`](https://github.com/tsviz/actions-runner-telemetry/blob/main/.github/workflows/example-usage.yml) for:
          - Basic telemetry (start/stop)
          - Per-step tracking workflow
          - Quick resource snapshot
          - Heavy workload with overutilization demo

          ## ðŸ”§ Configuration

          | Input | Description | Default |
          |-------|-------------|---------|
          | `enabled` | Enable/disable telemetry | `true` |
          | `mode` | Operation mode (start/stop/step/snapshot) | `start` |
          | `interval` | Metric sampling interval (seconds) | `2` |
          | `step-name` | Step name for tracking | `` |

          ## ðŸ“Š Report Contents

          ### Markdown Report
          - Quick overview gauges (CPU, Memory, Load)
          - Resource usage over time charts
          - Cost analysis with GitHub pricing
          - Right-sizing recommendations
          - Per-step performance breakdown
          - Top process information

          ### HTML Dashboard
          - Interactive Chart.js visualizations
          - Synchronized multi-metric charts
          - Drill-down capability on data points
          - Professional styling for sharing
          - Mobile-responsive design

          ## ðŸŽ¯ Use Cases

          1. **Cost Optimization** - Understand if you're paying for capacity you don't use
          2. **Performance Troubleshooting** - Identify bottlenecks and resource constraints
          3. **Right-Sizing** - Find the most cost-effective runner for your workload
          4. **Capacity Planning** - Track trends over time to predict growth
          5. **CI/CD Analysis** - Understand how your build affects runner resources

          ## ðŸ“ Release Notes

          ### What's New in v${{ steps.version.outputs.version }}

          - âœ… Cost optimization analysis with overutilization detection
          - âœ… Improved scoring logic (Grade D for jobs exceeding runner capacity)
          - âœ… GitHub pricing documentation integration
          - âœ… Robust JSON parsing with error recovery
          - âœ… Enhanced optimization strategy recommendations
          - âœ… Action version field in action.yml
          - âœ… Moving v1 tag for automatic updates

          ### Previous Versions

          See [releases](https://github.com/tsviz/actions-runner-telemetry/releases) for earlier versions and migration guides.

          ## ðŸ“– Documentation

          - [GitHub Actions Runner Pricing](https://docs.github.com/en/enterprise-cloud@latest/billing/reference/actions-runner-pricing)
          - [GitHub Actions Documentation](https://docs.github.com/en/actions)

          ## ðŸ“„ License

          See LICENSE file in repository.

          ---

          **Need help?** [Open an issue](https://github.com/tsviz/actions-runner-telemetry/issues) on GitHub.
          EOF
          echo "Release notes generated"

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: "Runner Telemetry v${{ steps.version.outputs.version }}"
          body_path: release_notes.md
          draft: false
          prerelease: ${{ contains(steps.version.outputs.version, 'alpha') || contains(steps.version.outputs.version, 'beta') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
